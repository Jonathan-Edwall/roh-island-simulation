---
output: 
  html_document: 
    toc: true
---

# 0: Preparation

Defining the input and output directories

```{r setup, echo = FALSE}

#echo = FALSE # Hides the code.
#results = 'hide' # Hides the output of the code.
#message = FALSE # Hides any messages generated by the code.
#warning = FALSE # Hides any warnings generated by the code.

# Clean the working environment
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)

####################################  
# Defining the working directory
#################################### 
# Set the path to your GitHub folder
YOUR_GITHUB_ROOT_DIRECTORY <- "C:/Users/jonat/GitHub"
# Defining the relative path in the repository
repository_path <- file.path(YOUR_GITHUB_ROOT_DIRECTORY,"roh-island-simulation")
#################################### 
# Defining Input parameters
#################################### 
# empirical_species <- "German Shepherd"
empirical_dog_breed <- "labrador_retriever"
empirical_species <- paste(toupper(substring(unlist(strsplit(empirical_dog_breed, "_")), 1, 1)),
                             substring(unlist(strsplit(empirical_dog_breed, "_")), 2),
                             sep = "", collapse = " ")

reference_population_for_snp_chip <- "last_breed_formation_generation"
document_title <- paste(empirical_species," Pipeline Results")
MAF_pruning_used <- FALSE
N_e_bottleneck <- 50
n_simulated_generations_breed_formation <- 98
document_title <- paste0(empirical_species," ",n_simulated_generations_breed_formation," Gen Breed Formation - SNP chip: ",reference_population_for_snp_chip," - ",N_e_bottleneck," N_e bottleneck scenario")
document_sub <- Sys.getenv("document_sub_title") 

# Parameters used for displaying the result
ROH_frequency_decimals <- 1
H_e_values_decimals <- 3
F_ROH_values_decimals <- 3
Window_lengths_decimals <- 2

histogram_line_sizes <- 3
empirical_data_color <- "darkgreen"
neutral_model_color <- "blue" 
selection_model_color <- "purple"

####################################  
# Defining the Input Directories
#################################### 
simulated_data_dir_basename <- "simulated-chr1_3185_Ne_50TC"
results_dir <- file.path(repository_path,"results_chr1_3185_Ne_50TC")
plink_ROH_dir <- file.path(results_dir,"PLINK/ROH")
# expected_heterozygosity_dir <- file.path(results_dir,"expected_heterozygosity_No_MAF")
expected_heterozygosity_dir <- file.path(results_dir,"expected_heterozygosity_MAF_0_01")
# expected_heterozygosity_dir <- file.path(results_dir,"expected_heterozygosity_MAF_0_05")
ROH_hotspots_dir <- file.path(results_dir,"ROH-Hotspots")
# Selection_strength_test_dir <- file.path(ROH_hotspots_dir,"selection_strength_test_No_MAF")
Selection_strength_test_dir <- file.path(ROH_hotspots_dir,"selection_strength_test_MAF_0_01")
# Selection_strength_test_dir <- file.path(ROH_hotspots_dir,"selection_strength_test_MAF_0_05")
# Sweep_test_dir <- file.path(ROH_hotspots_dir,"sweep_test_No_MAF")
Sweep_test_dir <- file.path(ROH_hotspots_dir,"sweep_test_MAF_0_01")
#¤¤¤¤¤¤¤¤ Simulated Data ¤¤¤¤¤¤¤¤
raw_data_dir <- file.path(repository_path,"data/raw")
raw_simulated_data_dir <- file.path(raw_data_dir,simulated_data_dir_basename)

############### 
## Empirical ###
###############
### ROH hotspots ###
Empirical_data_ROH_hotspots_dir  <- file.path(ROH_hotspots_dir,"empirical",empirical_dog_breed)
Empirical_data_autosome_ROH_freq_dir <- file.path(Empirical_data_ROH_hotspots_dir,"Gosling_plots/autosome_roh_freq")
### Inbreeding coefficient ###
Empirical_data_F_ROH_dir  <- file.path(plink_ROH_dir,"empirical",empirical_dog_breed,"F_ROH")
### Expected Heterozygosity distribution ###
Empirical_data_H_e_dir <- file.path(expected_heterozygosity_dir,"empirical",empirical_dog_breed)
############### 
## Simulated ###
###############
### ROH hotspots ###
Neutral_model_ROH_hotspots_dir  <- file.path(ROH_hotspots_dir,"simulated/neutral")
Neutral_model_autosome_ROH_freq_dir <- file.path(Neutral_model_ROH_hotspots_dir,"Gosling_plots/autosome_roh_freq")

Selection_model_ROH_hotspots_dir  <- file.path(ROH_hotspots_dir,"simulated/selection")
Selection_model_autosome_ROH_freq_dir <- file.path(Selection_model_ROH_hotspots_dir,"Gosling_plots/autosome_roh_freq")
### Inbreeding coefficient ###
Neutral_model_F_ROH_dir  <- file.path(plink_ROH_dir,"simulated/neutral_model/F_ROH")
Selection_model_F_ROH_dir  <- file.path(plink_ROH_dir,"simulated/selection_model/F_ROH")

### Expected Heterozygosity distribution ###
Neutral_model_H_e_dir <- file.path(expected_heterozygosity_dir,"simulated/neutral_model")
Selection_model_H_e_dir <- file.path(expected_heterozygosity_dir,"simulated/selection_model")
# Causative variant
Selection_causative_variant_windows_dir <- file.path(results_dir,"causative_variant_windows")
# causative_variant_windows_H_e_dir <- file.path(Selection_causative_variant_windows_dir,"H_e_No_MAF")
causative_variant_windows_H_e_dir <- file.path(Selection_causative_variant_windows_dir,"H_e_MAF_0_01")
# causative_variant_windows_H_e_dir <- file.path(Selection_causative_variant_windows_dir,"H_e_MAF_0_05")

raw_selection_dir <- file.path(raw_simulated_data_dir,"selection_model")
variant_freq_plots_dir <- file.path(raw_selection_dir,"variant_freq_plots")
variant_position_dir <- file.path(raw_selection_dir,"variant_position")
pruned_replicates_count_dir <- file.path(raw_selection_dir,"pruned_counts")
##################################### 
## Defining the Output Directory
##################################### 
output_dir <- file.path(results_dir,"Pipeline_results")

if (!dir.exists(output_dir)) {
  # Create the directory
  dir.create(output_dir, recursive = TRUE)
}

```

---
title: "`r document_title`"
subtitle: "`r document_sub`"
output:
  html_document:
    toc: true
    toc_depth: 3  
date: "`r Sys.Date()`"
editor_options: 
  markdown: 
    wrap: 72
---

## Loading libraries

```{r Loading Libraries,echo = FALSE}
if (!require(knitr)) install.packages("knitr", dependencies = TRUE)
library(knitr)
if (!require(ggplot2)) install.packages("ggplot2", dependencies = TRUE)
library(ggplot2)
if (!require(scatterplot3d)) install.packages("scatterplot3d", dependencies = TRUE)
library(scatterplot3d) # For generating the 3d plots 
if (!require(RColorBrewer)) install.packages("RColorBrewer", dependencies = TRUE)
library(RColorBrewer) # For generating a color palette

```






```{r , results='asis'}
min_MAF_selection_testing <- 0

# MAF_pruning_used <- FALSE
MAF_pruning_used <- TRUE
min_MAF_selection_testing <- "0.01"

if (MAF_pruning_used == FALSE) {
  MAF_settings_text <- paste0("No MAF-based pruning of markers performed") 
} else {
  MAF_settings_text <- paste0("Markers with MAF >= ",min_MAF_selection_testing," were pruned from the datasets before $H_{e}$ computation") 
}





```


# Latex formatting function

```{r ,echo = FALSE}
# Function to format and write a data frame to a LaTeX-compatible text file
write_latex_table <- function(data_frame, sort_column, output_dir, output_filename) {
  # Sort the data frame based on the specified column
  sorted_df <- data_frame[order(data_frame[[sort_column]]), ]
  # Define the complete file path
  file_path <- file.path(output_dir, paste(output_filename, ".txt", sep = ""))
  # Open a connection to the file for writing
  file_conn <- file(file_path, open = "wt")

  # Loop through each row in the sorted DataFrame
  for (i in 1:nrow(sorted_df)) {
    # Format the row with & separator and \\ at the end
    formatted_row <- paste(sorted_df[i, ], collapse = " & ")
    formatted_row <- paste(formatted_row, "\\\\", sep = "")
    # Write the formatted row to the file
    cat(formatted_row, file = file_conn, sep = "\n")
  }
  # Close the file connection
  close(file_conn)
  # Return the file path for reference
  return(file_path)
}
```

# Standard Error Confidence interval function

```{r ,echo = FALSE}
# Function to calculate standard error and its confidence interval
standard_error_confidence_interval_fun <- function(observed_data, confidence_level = 0.95) {
  if ( length(observed_data) > 1 ) {
    # Calculate standard error
    n <- length(observed_data)
    standard_deviation <- sd(observed_data)
    standard_error <- standard_deviation / sqrt(n - 1)
    # Calculate confidence interval based on standard error
    alpha <- (1 - confidence_level) / 2
    margin_of_error <- qnorm(1 - alpha) * standard_error
    mean_estimate <- mean(observed_data)
    # Calculate the percentiles for the confidence interval
    confidence_interval_lower_bound <- mean_estimate - margin_of_error # 2.5th percentile (2σ)
    confidence_interval_upper_bound <- mean_estimate + margin_of_error # 97.5th percentile (2σ)
    # Return confidence interval
    return(c(confidence_interval_lower_bound, confidence_interval_upper_bound))
  } else {
    return(c(NA,NA)) 
    }
} 
```


# Gene mapping
```{r ,echo = FALSE,results= 'hide',warning = FALSE}
# Empirical_data_hotspot_gene_mapping_dir <- file.path(Empirical_data_ROH_hotspots_dir,"hotspot_gene_mapping")
# setwd(Empirical_data_hotspot_gene_mapping_dir)
# 
# "labrador_retriever_chr6_ROH_Hotspot_windows_gene_names.txt"
# # Pattern for finding files containing "pruned_replicates_count" and ending with ".tsv"
# pattern <- ".*gene_names*\\.txt$"
# hotspot_gene_mapping_files <- list.files(path = Empirical_data_hotspot_gene_mapping_dir, pattern = pattern)
# 
# hotspot_gene_mapping_files
```


```{r ,echo = FALSE,results= 'hide',warning = FALSE}
# # Define the directory and pattern for the files
# Empirical_data_hotspot_gene_mapping_dir <- file.path(Empirical_data_ROH_hotspots_dir, "hotspot_gene_mapping")
# setwd(Empirical_data_hotspot_gene_mapping_dir)
# 
# # Pattern for finding the gene mapping files
# pattern <- ".*gene_names*\\.txt$"
# hotspot_gene_mapping_files <- list.files(path = Empirical_data_hotspot_gene_mapping_dir, pattern = pattern)
# 
# # Extract chromosome numbers from the filenames
# chr_number_pattern <- ".*_chr(\\d+)_.*\\.txt$"
# chr_numbers <- as.numeric(gsub(tolower(chr_number_pattern), "\\1", tolower(hotspot_gene_mapping_files)))
# 
# # Create a data frame with file and chromosome information
# chr_info <- data.frame(
#   chr_number = chr_numbers, 
#   file_name = hotspot_gene_mapping_files, 
#   stringsAsFactors = FALSE
# )
# 
# # Sort the dataframe by chromosome number
# chr_info <- chr_info[order(chr_info$chr_number), ]
# 
# # Initialize an empty list to store the gene mapping tables by chromosome
# gene_mapping_tables <- list()
# 
# # Loop through each file and store data by chromosome
# for (i in 1:nrow(chr_info)) {
#   file <- chr_info$file_name[i]
#   chr <- chr_info$chr_number[i]
#   
#   # Read the file into a data frame
#   gene_mapping_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, sep = "\t")
#   colnames(gene_mapping_data)[1] <- "Genes"
#   
#   # Add chromosome number as an attribute
#   attr(gene_mapping_data, "Chromosome_number") <- chr
#   
#   # Store the gene mapping data under the corresponding chromosome number
#   gene_mapping_tables[[paste0("chr", chr)]] <- gene_mapping_data
# }
# 
# # Output the results
# # print(gene_mapping_tables)
# 
# # To view a specific chromosome table:
# # View(gene_mapping_tables[["chr1"]])
# View(gene_mapping_tables)
# 
# 
# 
# # Print the table using kable
# # kable(gene_mapping_tables,row.names = FALSE)

```

# 2: ROH-Frequency

## 2.1: Autosome ROH-frequencies

### 2.1.1: Empirical - ROH frequency

```{r Empirical - ROH frequency,echo = FALSE,results= 'hide',warning = FALSE}
setwd(Empirical_data_autosome_ROH_freq_dir)
# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- ".*ROH_freq.*\\.tsv$"
population_ROH_freq_files <- list.files(path = Empirical_data_autosome_ROH_freq_dir, pattern = pattern)
#population_ROH_freq_files
# Extracting the ROH-hotspot threshold value from the suffix of the filename
parts <- unlist(strsplit(population_ROH_freq_files[1], "threshold_")) # Split the string by "threshold_"
# Extract the decimal number using regular expressions
Empirical_data_ROH_hotspot_threshold <- as.numeric(gsub("\\.tsv", "", unlist(strsplit(parts[length(parts)], "_"))[1]))
# Extract chromosome numbers from filenames
chr_numbers <- as.numeric(gsub(tolower(".*CHR(\\d+)_.*"), "\\1", tolower(population_ROH_freq_files)))
# cat("CHR Values:", chr_numbers, "\n")
# Sort filenames based on chromosome numbers
sorted_population_ROH_freq_files <- population_ROH_freq_files[order(chr_numbers)]
# Initialize an empty list to store the ROH-frequency data
ROH_freq_table_Empirical_Data <- list()

# Loop through each sorted .tsv file
for (file in sorted_population_ROH_freq_files) {
  file_name <- file
  ROH_freq_data <- read.table(file, header = TRUE, comment.char = "#", stringsAsFactors = FALSE, sep = "\t")
  ROH_freq_data <- ROH_freq_data[1:(nrow(ROH_freq_data)/2), ]
  # Renaming POS to POS1 and add POS2 = POS1 + 1e5
  ROH_freq_data <- transform(ROH_freq_data, POS1 = POS, POS2 = POS + 1e5 -1)
  # Remove the original POS column
  ROH_freq_data <- ROH_freq_data[, c("CHR", "POS1", "POS2", "COUNT", "FREQUENCY")]
  # Add chromosome_name as an attribute to the data frame
  chr_num <- as.numeric(gsub(tolower(".*CHR(\\d+)_.*"), "\\1", tolower(file)))
  attr(ROH_freq_data, "chromosome_name") <- chr_num
  # Create a list with table name and corresponding data frame
  table_info <- list(chromosome_name = chr_num, filename = file_name, data = ROH_freq_data)  # Added chromosome_name here
  # Append the table info to the list
  ROH_freq_table_Empirical_Data <- c(ROH_freq_table_Empirical_Data, list(table_info))
}
ROH_freq_table_Empirical_Data$ROH_hotspot_threshold <- Empirical_data_ROH_hotspot_threshold
#View(ROH_freq_table_Empirical_Data)
```
## 2.2: ROH-hotspots - ROH Frequency and Length

```{r ,echo = FALSE,warning = FALSE}
setwd(Empirical_data_ROH_hotspots_dir)
# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- "^.*ROH_Hotspot_windows*.bed$"
empirical_roh_hotspot_bed_files <- list.files(path = Empirical_data_ROH_hotspots_dir, pattern = pattern)
# chromosome_number_pattern <- "^german_shepherd_CHR(\\d+)_.*"
chromosome_number_pattern <- paste0("^",empirical_dog_breed,"_chr(\\d+)_.*")
# Extract chromosome numbers
chr_numbers <- sub(tolower(chromosome_number_pattern), "\\1", tolower(empirical_roh_hotspot_bed_files))
# Sort the files based on chromosome numbers
empirical_roh_hotspot_bed_files <- empirical_roh_hotspot_bed_files[order(as.numeric(chr_numbers))]
# Create an empty list to store information for the different ROH-hotspots in
empirical_hotspot_tables <- list()

# Loop through each .bed file (ROH-hotspot allele frequency window-file)
for (file in empirical_roh_hotspot_bed_files) {
  # Extract chromosome number and window number from file name
  chromosome <- as.numeric(sub(tolower(chromosome_number_pattern), "\\1", tolower(file)))
  column_names <- c("CHR","POS1","POS2")
  # Read the .bed file into a data frame, skipping commented lines
  chromosome_bed_file_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)
  
  # Loop through each hotspot for the current chromosome
  for (i in 1:nrow(chromosome_bed_file_data)) {
    Hotspot_region_data <- data.frame(CHR = chromosome_bed_file_data[i, ][1],POS1 = chromosome_bed_file_data[i, ][2],POS2 = chromosome_bed_file_data[i, ][3])
    Hotspot_length_bp <- Hotspot_region_data$POS2-Hotspot_region_data$POS1 + 1
    Hotspot_length_Mb <- Hotspot_length_bp / 1e6
    Hotspot_name <- paste("Hotspot_chr",chromosome, "_window_",i, sep = "")
    # Find the row where the variant_position_bp is within POS1 and POS2, and CHR equals chr_number
    roh_freq_windows_in_hotspot <- ROH_freq_table_Empirical_Data[[chromosome]][["data"]][ Hotspot_region_data$POS1 <= ROH_freq_table_Empirical_Data[[chromosome]][["data"]]$POS1 & ROH_freq_table_Empirical_Data[[chromosome]][["data"]]$POS2 <= Hotspot_region_data$POS2, ]
    avg_frequency <- mean(roh_freq_windows_in_hotspot$FREQUENCY)
    # Check if the selection coefficient already exists in the list
    if (!(Hotspot_name %in% names(empirical_hotspot_tables))) {
      # If it doesn't exist, create an empty data frame
      empirical_hotspot_tables[[Hotspot_name]] <- data.frame()
    }
    # Create a list with table name and corresponding data frame
    table_info <- list(Filename = file,Hotspot_length_bp=Hotspot_length_bp,Hotspot_length_Mb=Hotspot_length_Mb,Avg_frequency = avg_frequency, Hotspot_region_data = Hotspot_region_data) 
    # Append the table info to the list under selection_scenario
    empirical_hotspot_tables[[Hotspot_name]] <- c(empirical_hotspot_tables[[Hotspot_name]], table_info)
           }
}
# View(empirical_hotspot_tables)
```


# 5: Summary

## 5.1: General comparison

## 5.2: Selection Testing of Empirical ROH-Hotspots

### 5.2.1: Selection test (Sweep test)

```{r Sweep test, echo = FALSE,warning = FALSE, results='asis'}
setwd(Sweep_test_dir)
# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- "^.*neutral_model.*.tsv$"
selection_testing_files <- list.files(path = Sweep_test_dir, pattern = pattern)
# Extracting the ROH-hotspot threshold value from the suffix of the filename
parts <- unlist(strsplit(selection_testing_files[1], "thr_")) # Split the string by "threshold_"
# Extract the decimal number using regular expressions
fifth_percentile_H_e_neutral_model <- as.numeric(gsub("\\.tsv", "", unlist(strsplit(parts[length(parts)], "_"))[1]))

for (file in selection_testing_files) {
  file_name <- file
  # Read the header line
  con <- file(file, "r")
  header <- readLines(con, n = 1)
  close(con)
  # Remove "#" from the header and split it into column names
  column_names <- sub("#", "", header)
  column_names <- strsplit(column_names, "\t")[[1]]
  # Read the .tsv frequency file into a data frame
  Selection_testing_results <- read.table(selection_testing_files, header = TRUE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)
  Selection_testing_results[3] <- round(Selection_testing_results[3],H_e_values_decimals)
  # Remove "_allele_freq" from the names
  Selection_testing_results$Name <- gsub(tolower("_allele_freq$"), "", tolower(Selection_testing_results$Name))

}
cat("Selection test results. \n\n")
cat("ROH-hotspot windows with an mean H_e Value lower or equal to the lower confidence interval of the fifth percentile of the neutral model are classified as being under selection.\n\n")
cat("5th percentile of the neutral model is: ",fifth_percentile_H_e_neutral_model)
# Print the table using knitr::kable()
knitr::kable(Selection_testing_results, row.names = FALSE) 
formatted_selection_H_e_threshold <- round(fifth_percentile_H_e_neutral_model,H_e_values_decimals)
#Define the filename with the output directory path
filename_csv <- file.path(output_dir, paste("ROH_hotspots_Sweep_test_H_E_threshold_",formatted_selection_H_e_threshold,".csv", sep = ""))
Selection_testing_results_latex <- Selection_testing_results
# Escape underscores in the Name column
Selection_testing_results_latex$Name <- gsub("_", "\\_", Selection_testing_results_latex$Name, fixed = TRUE)
# Write data to CSV file without quotes
write.table(Selection_testing_results_latex, file = filename_csv, sep = ",", row.names = FALSE, quote = FALSE)
# Define the filename with the output directory path
filename <- file.path(paste("ROH_hotspots_Selection_testing_neutral_model_H_E_threshold_",formatted_selection_H_e_threshold,".csv", sep = ""))
# Use the write_latex_table() function to write the data to a LaTeX-compatible text file
write_latex_table(
  data_frame = Selection_testing_results,
  sort_column = "Window_based_Average_H_e",  #
  output_dir = output_dir,
  output_filename = filename  
)
# Subset the dataframe to extract rows where Under_selection is "Yes"
under_selection_rows <- subset(Selection_testing_results, Under_selection == "Yes")
paste0("ROH-hotspots under selection:")
knitr::kable(under_selection_rows, row.names = FALSE) 
#View(Selection_testing_results)
```
### 5.2.3: Extracting Hotspots under selection

```{r echo = FALSE,warning = FALSE}
# Initialize an empty list to store the new table
hotspot_under_selection_H_e_table <- list()

# If no Hotspot is under selection, then display all hotspots instead
if (nrow(under_selection_rows) == 0) {
  under_selection_rows <- Selection_testing_results
}
# Loop through each row in under_selection_rows
for (i in 1:nrow(under_selection_rows)) {
  # Extract information for the current ROH-hotspot window
  current_window <- under_selection_rows[i, "Name"]
  under_selection <- under_selection_rows[i, "Under_selection"]
  Hotspot_Avg_H_e <- under_selection_rows[i, "Window_based_Average_H_e"]
  # Initialize a subtable for the current ROH-hotspot window
  subtable <- list()
  # Create a list with table name and corresponding data frame
  table_info <- list(Hotspot_Avg_H_e = Hotspot_Avg_H_e, coefficient_data = subtable)
  # Add the subtable for the current ROH-hotspot window to the new table
  hotspot_under_selection_H_e_table[[current_window]] <- c(hotspot_under_selection_H_e_table[[current_window]],table_info)
}
# View the new table
# View(hotspot_under_selection_H_e_table)
```

# Phenotype Mapping
# 5. OMIA Phenotypes

```{r}
omia_phenotypes_filepath <-"C:/Users/jonat/GitHub/roh-island-simulation/data/preprocessed/empirical/omia_phenotype_data/All_dog_phenotypes.bed"
vertebrate_breed_ontology_ids <- "VBO_0200800,Unspecified" # Identifying phenotypes labeled as either related to "Labrador retriever dog" or "unidentified breed"
# setwd(omia_phenotype_data_dir)

file <- file.path(omia_phenotypes_filepath)
#  # Read the header (the line starting with #)
header_line <- readLines(file, n = 1)  # Read the first line
header <- unlist(strsplit(sub("^#", "", header_line), "\t"))  # Remove the "#" and split by tab

# Read the data (skip the first line since it's the header)
omia_phenotype_data <- read.table(file, 
                                  header =  FALSE, 
                                  comment.char = "#", 
                                  stringsAsFactors = FALSE, 
                                  sep = "\t", 
                                  skip = 1,
                                  quote = "")

# # Read the data (skip the first line since it's the header)
# omia_phenotype_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, sep = "\t", skip = 1)

# Assign the extracted header as column names
colnames(omia_phenotype_data) <- header

# ---- Rename Columns for POS1 and POS2 ----
colnames(omia_phenotype_data)[1] <- "CHR"  # V5 as POS1 (start position)
colnames(omia_phenotype_data)[2] <- "POS1"  # V5 as POS1 (start position)
colnames(omia_phenotype_data)[3] <- "POS2"  # V6 as POS2 (end position)
colnames(omia_phenotype_data)[4] <- "PHENE"  
colnames(omia_phenotype_data)[5] <- "PHENE_CATEGORY" 
colnames(omia_phenotype_data)[6] <- "SINGLE_GENE_TRAIT_OR_DISORDER"  
colnames(omia_phenotype_data)[7] <- "DISEASE_RELATED" 
colnames(omia_phenotype_data)[8] <- "GENE_SYMBOL"  
colnames(omia_phenotype_data)[9] <- "GENE_DESCRIPTION" 
colnames(omia_phenotype_data)[10] <- "PHENE_URL"  
colnames(omia_phenotype_data)[11] <- "GENE_DETAILS_URL" 
colnames(omia_phenotype_data)[12] <- "BREEDS" 

# ---- Ensure POS1 and POS2 are Numeric ----
omia_phenotype_data$CHR <- as.numeric(omia_phenotype_data$CHR)
omia_phenotype_data$POS1 <- as.numeric(omia_phenotype_data$POS1)
omia_phenotype_data$POS2 <- as.numeric(omia_phenotype_data$POS2)



View(omia_phenotype_data)




```





<!-- Extracting all phenotypes -->
```{r OMIA Phenotypes, echo=FALSE,results= 'hide',warning = FALSE}
omia_phenotypes_filepath <-"C:/Users/jonat/GitHub/roh-island-simulation/data/preprocessed/empirical/omia_phenotype_data/All_dog_phenotypes.bed"
vertebrate_breed_ontology_ids <- "VBO_0200800,Unspecified" # Identifying phenotypes labeled as either related to "Labrador retriever dog" or "unidentified breed"
# setwd(omia_phenotype_data_dir)

vertebrate_breed_ontology_ids_vector <- unlist(strsplit(vertebrate_breed_ontology_ids, ","))

file <- file.path(omia_phenotypes_filepath)
#  # Read the header (the line starting with #)
header_line <- readLines(file, n = 1)  # Read the first line
header <- unlist(strsplit(sub("^#", "", header_line), "\t"))  # Remove the "#" and split by tab

# Read the data (skip the first line since it's the header)
omia_phenotype_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, sep = "\t", skip = 1)

# Assign the extracted header as column names
colnames(omia_phenotype_data) <- header

# ---- Rename Columns for POS1 and POS2 ----
colnames(omia_phenotype_data)[1] <- "CHR"  # V5 as POS1 (start position)
colnames(omia_phenotype_data)[2] <- "POS1"  # V5 as POS1 (start position)
colnames(omia_phenotype_data)[3] <- "POS2"  # V6 as POS2 (end position)
colnames(omia_phenotype_data)[4] <- "PHENE"  
colnames(omia_phenotype_data)[5] <- "PHENE_CATEGORY" 
colnames(omia_phenotype_data)[6] <- "SINGLE_GENE_TRAIT_OR_DISORDER"  
colnames(omia_phenotype_data)[7] <- "DISEASE_RELATED" 
colnames(omia_phenotype_data)[8] <- "GENE_SYMBOL"  
colnames(omia_phenotype_data)[9] <- "GENE_DESCRIPTION" 
colnames(omia_phenotype_data)[10] <- "PHENE_URL"  
colnames(omia_phenotype_data)[11] <- "GENE_DETAILS_URL" 
colnames(omia_phenotype_data)[12] <- "BREEDS" 

# ---- Ensure POS1 and POS2 are Numeric ----
omia_phenotype_data$CHR <- as.numeric(omia_phenotype_data$CHR)
omia_phenotype_data$POS1 <- as.numeric(omia_phenotype_data$POS1)
omia_phenotype_data$POS2 <- as.numeric(omia_phenotype_data$POS2)



View(omia_phenotype_data)
```

```{r echo=FALSE,results= 'hide',warning = FALSE}
Empirical_data_hotspot_phenotype_mapping_dir <- file.path(Empirical_data_ROH_hotspots_dir,"hotspot_phenotype_mapping")
setwd(Empirical_data_hotspot_phenotype_mapping_dir)
setwd(Empirical_data_hotspot_phenotype_mapping_dir)

# Pattern for finding the phenotype mapping files
pattern <- ".*phenotypes*\\.bed$"
hotspot_phenotype_mapping_files <- list.files(path = Empirical_data_hotspot_phenotype_mapping_dir, pattern = pattern)

# Extract chromosome numbers from the filenames
chr_number_pattern <- ".*_chr(\\d+)_.*\\.bed$"
chr_numbers <- as.numeric(gsub(tolower(chr_number_pattern), "\\1", tolower(hotspot_phenotype_mapping_files)))

# Create a data frame with file and chromosome information
chr_info <- data.frame(
  chr_number = chr_numbers, 
  file_name = hotspot_phenotype_mapping_files, 
  stringsAsFactors = FALSE
)

# Sort the dataframe by chromosome number
chr_info <- chr_info[order(chr_info$chr_number), ]




# Initialize an empty list to store the phenotype mapping tables by chromosome
phenotype_location_tables <- list()   # Simplified table with Phenotype, POS1, and POS2

# Loop through each file and store data by chromosome
for (i in 1:nrow(chr_info)) {
  chr <- chr_info$chr_number[i]
  file <- chr_info$file_name[i]
  
  
  #  # Read the header (the line starting with #)
  header_line <- readLines(file, n = 1)  # Read the first line
  header <- unlist(strsplit(sub("^#", "", header_line), "\t"))  # Remove the "#" and split by tab
  
  # Read the data (skip the first line since it's the header)
  phenotype_mapping_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, sep = "\t", skip = 1)
  
  # Assign the extracted header as column names
  colnames(phenotype_mapping_data) <- header
  
  # ---- Rename Columns for POS1 and POS2 ----
    colnames(phenotype_mapping_data)[1] <- "CHR"  # V5 as POS1 (start position)
  colnames(phenotype_mapping_data)[2] <- "POS1"  # V5 as POS1 (start position)
  colnames(phenotype_mapping_data)[3] <- "POS2"  # V6 as POS2 (end position)
  colnames(phenotype_mapping_data)[4] <- "Phene"  # V6 as POS2 (end position)
  
  # ---- Ensure POS1 and POS2 are Numeric ----
  phenotype_mapping_data$POS1 <- as.numeric(phenotype_mapping_data$POS1)
  phenotype_mapping_data$POS2 <- as.numeric(phenotype_mapping_data$POS2)
  
  # ---- Remove Rows with Missing POS1 or POS2 ----
  phenotype_mapping_data <- phenotype_mapping_data[!is.na(phenotype_mapping_data$POS1) & !is.na(phenotype_mapping_data$POS2), ]
  
  # ---- Find Unique Phenotypes ----
  unique_phenotypes <- unique(phenotype_mapping_data$Phene)
  
  # ---- Initialize an Empty Data Frame for Aggregated Data ----
  aggregated_phenotype_data <- data.frame(Phene = character(), POS1 = numeric(), POS2 = numeric(), stringsAsFactors = FALSE)
  
  # ---- Inner Loop: Aggregate Data for Each Unique Phenotype ----
  for (phenotype in unique_phenotypes) {
    phenotype_rows <- phenotype_mapping_data[phenotype_mapping_data$Phene == phenotype, ]  # Filter rows for the phenotype
    
    min_pos1 <- min(phenotype_rows$POS1)  # Find minimum POS1 for this phenotype
    max_pos2 <- max(phenotype_rows$POS2)  # Find maximum POS2 for this phenotype
    
    # Append the result to aggregated_phenotype_data
    aggregated_phenotype_data <- rbind(aggregated_phenotype_data, data.frame(Phene = phenotype, POS1 = min_pos1, POS2 = max_pos2))
  }
  
  # Store the result in phenotype_location_tables
  phenotype_location_tables[[paste0("chr", chr)]] <- aggregated_phenotype_data
}

# Output the results
View(phenotype_location_tables)    # Only Phenotype, POS1, and POS2


```


## Detect phenotypes overlapping with ROH-hotspots
```{r echo=FALSE,results= 'hide',warning = FALSE}

# Convert phenotype location list to a single dataframe
phenotype_location_tables_flat <- do.call(rbind, lapply(names(phenotype_location_tables), function(chr) {
  df <- phenotype_location_tables[[chr]]
  df$CHR <- gsub("chr", "", chr)  # Remove "chr" prefix
  df[c("CHR", "POS1", "POS2", "Phene")]  # Reorder columns
}))

# Convert CHR column to numeric if needed
phenotype_location_tables_flat$CHR <- as.numeric(phenotype_location_tables_flat$CHR)

# Print the final merged table
print(phenotype_location_tables_flat)

# View(phenotype_location_tables)
# View(empirical_hotspot_tables)
for (i in seq_along(empirical_hotspot_tables)) {
  # Extract chromosome and hotspot region boundaries
  CHR <- empirical_hotspot_tables[[i]][["Hotspot_region_data"]][["CHR"]]
  POS1 <- empirical_hotspot_tables[[i]][["Hotspot_region_data"]][["POS1"]]
  POS2 <- empirical_hotspot_tables[[i]][["Hotspot_region_data"]][["POS2"]]
  cat("Hotspot Window -> POS1:", POS1, " POS2:", POS2, "\n")
  
  # Find phenotypes that partially or fully overlap the hotspot region
  overlapping_phenotypes <- phenotype_location_tables_flat[
    phenotype_location_tables_flat$CHR == CHR & 
    phenotype_location_tables_flat$POS2 >= POS1 &  # Phenotype end is after or at the region start
    phenotype_location_tables_flat$POS1 <= POS2,   # Phenotype start is before or at the region end
  ]

  # Compute Overlap_Percentage for each phenotype
  if (nrow(overlapping_phenotypes) > 0) {
    overlapping_phenotypes$Overlap_Percentage <- apply(overlapping_phenotypes, 1, function(phenotype) {
      phenotype_start <- as.numeric(phenotype["POS1"])
      phenotype_end <- as.numeric(phenotype["POS2"])
      phenotype_length <- phenotype_end - phenotype_start + 1  # Total phenotype length

      # Compute upstream and downstream outside portions
      upstream_outside <- max(0, POS1 - phenotype_start)  # If phenotype starts before hotspot
      downstream_outside <- max(0, phenotype_end - POS2)  # If phenotype ends after hotspot
      outside_portion <- upstream_outside + downstream_outside

      # Compute Overlap Percentage
      Overlap_Percentage <- 100 * (1 - (outside_portion / phenotype_length))
      return(Overlap_Percentage)
    })
  } else {
    overlapping_phenotypes$Hotspot_Overlap_Perc <- numeric(0)  # Empty case
  }

  # Store results
  empirical_hotspot_tables[[i]][["Hotspot_phenotypes"]] <- overlapping_phenotypes
}




```
## Show phenotypes for Hotspots under selection
```{r ,echo = FALSE,warning = FALSE, results='asis'}
#echo = FALSE,warning = FALSE
# Initialize the empty list
Phenotypes_hotspots_under_selection <- list()

# Sorting in alphanumerical order
hotspots_under_selection <- under_selection_rows[order(under_selection_rows$Name), ]

# Loop through each hotspot and filter under selection
for (hotspot in names(empirical_hotspot_tables)) {
  for (selection_hotspot_index in 1:nrow(hotspots_under_selection)) {
    if (tolower(hotspot) == tolower(hotspots_under_selection$Name[selection_hotspot_index])) {
      
      # Extract the phenotypes for the selected hotspot
      phenotypes_data <- empirical_hotspot_tables[[hotspot]][["Hotspot_phenotypes"]]
      
      # Append to the list if phenotypes are found
      if (!is.null(phenotypes_data) && nrow(phenotypes_data) > 0) {
        Phenotypes_hotspots_under_selection[[hotspot]] <- phenotypes_data
      }
      else {
        # Create an empty table for this hotspot and append
        Phenotypes_hotspots_under_selection[[hotspot]] <- data.frame(CHR = character(0),
                                                                POS1 = numeric(0),
                                                                POS2 = numeric(0),
                                                                Phenotype = character(0),
                                                                Overlap_Percentage = numeric(0))
    }}
  }
}

# Check if there are any phenotypes under selection and display a message with the tables
if (length(Phenotypes_hotspots_under_selection) > 0) {
  # Print a phenotyperal message before displaying tables
  # cat("\n### Phenotypes for Hotspot regions whom are candidates for Selection\n")
  cat("The following table(s) display the phenotypes overlapping with the candidate regions (ROH hotspots) for selection, in the following order:\n",hotspots_under_selection$Name,"\n")
  
  # Display the entire table for all hotspots
  knitr::kables(Phenotypes_hotspots_under_selection, caption = "Phenotypes belonging to the hotspots under selection")
  
#   kable(list(d1, d2), caption = "A tale of two tables")
# kables(list(kable(d1, align = "l"), kable(d2)), caption = "A tale of two tables")
  
  
} else {
  cat("No matching hotspots found under selection.\n")  # If no hotspots found
}
```
```{r}

```



```{r}
 #Generate a list of kable tables
table_list <- lapply(Phenotypes_hotspots_under_selection, function(df) {
  if (nrow(df) > 0) {
    kable(df, format = "html")  
  } 
})

# Print the tables stacked vertically 
kables(table_list)

```


```{r}
d1 = head(iris)
d2 = head(mtcars)

#multiple tables via either kable(list(x1, x2)) or kables(list(kable(x1),
# kable(x2)))
kable(list(d1, d2), caption = "A tale of two tables")
kables(list(kable(d1, align = "l"), kable(d2)), caption = "A tale of two tables")
```


# Raw input file
```{r}
Empirical_omia_scraped_phenotypes_data_dir <- file.path(raw_data_dir,"empirical/omia_scraped_phene_data")
setwd(Empirical_omia_scraped_phenotypes_data_dir)


vertebrate_breed_ontology_ids <- "VBO_0200800,Unspecified" # Identifying phenotypes labeled as either related to "Labrador retriever dog" or "unidentified breed"
vertebrate_breed_ontology_ids_vector <- unlist(strsplit(vertebrate_breed_ontology_ids, ","))

omia_scraped_phenotypes_data_filepath <-"C:/Users/jonat/GitHub/roh-island-simulation/data/raw/empirical/omia_scraped_phene_data/OMIA_dog_phenotype_data_raw.csv"

file <- file.path(omia_scraped_phenotypes_data_filepath)
#  # Read the header (the line starting with #)
header_line <- readLines(file, n = 1)  # Read the first line
header <- unlist(strsplit(sub("^#", "", header_line), ","))  # Remove the "#" and split by tab

# Read the data (skip the first line since it's the header)
omia_raw_phenotype_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, sep = ",", skip = 1)

# Assign the extracted header as column names
colnames(omia_raw_phenotype_data) <- header

# # ---- Rename Columns for POS1 and POS2 ----
# colnames(omia_phenotype_data)[1] <- "CHR"  # V5 as POS1 (start position)
# colnames(omia_phenotype_data)[2] <- "POS1"  # V5 as POS1 (start position)
# colnames(omia_phenotype_data)[3] <- "POS2"  # V6 as POS2 (end position)
# colnames(omia_phenotype_data)[4] <- "PHENE"  
# colnames(omia_phenotype_data)[5] <- "PHENE_CATEGORY" 
# colnames(omia_phenotype_data)[6] <- "SINGLE_GENE_TRAIT_OR_DISORDER"  
# colnames(omia_phenotype_data)[7] <- "DISEASE_RELATED" 
# colnames(omia_phenotype_data)[8] <- "GENE_SYMBOL"  
# colnames(omia_phenotype_data)[9] <- "GENE_DESCRIPTION" 
# colnames(omia_phenotype_data)[10] <- "PHENE_URL"  
# colnames(omia_phenotype_data)[11] <- "GENE_DETAILS_URL" 
# colnames(omia_phenotype_data)[12] <- "BREEDS" 

# ---- Ensure POS1 and POS2 are Numeric ----
# omia_raw_phenotype_data$POS1 <- as.numeric(omia_raw_phenotype_data$POS1)
# omia_raw_phenotype_data$POS2 <- as.numeric(omia_raw_phenotype_data$POS2)

View(omia_raw_phenotype_data)

```
### 5.1 All Breed-Specific Non-Defect (Non-Disease-Related) Phenotypes 
```{r 5.1 All Breed-Specific Non-Defect (Non-Disease-Related) Phenotypes, echo=FALSE,warning = FALSE}

#################################################################################### 
### Step 1: Detect all Breed-specific non-defect (non-disease-related) phenotypes of the specified breed
####################################################################################

unmapped_breed_phenotypes_tables <- list()

for (i in seq_along(vertebrate_breed_ontology_ids_vector)) {
  
  if (tolower(vertebrate_breed_ontology_ids_vector[i]) == "unspecified") {
      matching_OMIA_phenotypes <- omia_raw_phenotype_data[
    omia_raw_phenotype_data[12] == "" 
    & tolower(omia_raw_phenotype_data$DISEASE_RELATED) != "yes"
    & omia_raw_phenotype_data[1] == ""
    
      , ]
      
      # Remove rows having the substring "disease" in the phene_category.
      matching_OMIA_phenotypes <- matching_OMIA_phenotypes[
    !grepl("disease", matching_OMIA_phenotypes[, 5])
    , ]

  } else {
    matching_OMIA_phenotypes <- omia_raw_phenotype_data[
     grepl(vertebrate_breed_ontology_ids_vector[i], omia_raw_phenotype_data[, 12])
     & tolower(omia_raw_phenotype_data$DISEASE_RELATED) != "yes" & omia_raw_phenotype_data[, 1] == ""
     , ]
    
    
  }
  
  unmapped_breed_phenotypes_tables[[vertebrate_breed_ontology_ids_vector[i]]]  <- matching_OMIA_phenotypes

}
View(unmapped_breed_phenotypes_tables)

# # Display the entire table for all hotspots
# knitr::kable(Breed_phenotypes_tables, row.names = FALSE, 
#                caption = "Table showing all Non-Defect (Non-Disease-Related) breed-related phenotypes, discovered on OMIA")

# Display the entire table of all All Breed-Specific Non-Defect (Non-Disease-Related) Phenotypes, by generating a list of kable tables
Breed_phenotypes_tables_list <- lapply(unmapped_breed_phenotypes_tables, function(df) {
    if (nrow(df) > 0) {
      kable(df, format = "pipe",row.names = FALSE,longtable = TRUE, digits = 2, padding = 2)  
    } 
  })

  # Print the tables stacked vertically 
  knitr::kables(Breed_phenotypes_tables_list,
               caption = "Table showing all Non-Defect (Non-Disease-Related) breed-related phenotypes, discovered on OMIA")
  

  
  


```









